#!/bin/bash
if [ ! -d /home/vagrant/firmadyne ]; then
  apt-get install -y \
    busybox-static \
    fakeroot \
    git \
    dmsetup \
    kpartx \
    netcat-openbsd \
    nmap \
    python-psycopg2 \
    python3-psycopg2 \
    snmp \
    uml-utilities \
    util-linux \
    vlan \
    postgresql \
    qemu-system-arm \
    qemu-system-mips \
    qemu-system-x86 \
    qemu-utils
  
  git clone --recursive https://github.com/firmadyne/firmadyne.git
  
  sudo -u postgres createuser firmadyne
  sudo -u postgres psql 'ALTER ROLE firmadyne WITH PASSWORD "firmadyne";'
  sudo -u postgres createdb -O firmadyne firmware
  sudo -u postgres psql -d firmware < ./firmadyne/database/schema
  
  (cd ./firmadyne \
    && ./download.sh)
fi
